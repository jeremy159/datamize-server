<!-- prettier-ignore -->
{% extends "layouts/main.html" %}

{% block title %}Year Details{% endblock %}

{% block content %}
<div class="flex">
  <div role="tablist" class="tabs tabs-lg tabs-bordered flex-1">
    {% for y in years %} {% if y.clone() == year %}
    <a role="tab" class="tab tab-active"
      ><span class="mr-2">{{ y }}</span
      ><button
        class="btn btn-square btn-sm btn-ghost hover:bg-error"
        hx-delete="/balance_sheet/years/{{ year }}"
        hx-confirm="Are you sure you want to delete year {{ year }}?"
        hx-target="body"
        title="Delete Year"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg></button
    ></a>
    {% else %}
    <a
      role="tab"
      class="tab"
      href="/balance_sheet/years/{{ y }}"
      hx-target="#main"
      hx-select="#main > *"
      >{{ y }}</a
    >
    {% endif %} {% endfor %}
  </div>
  <div class="flex-none">
    <button
      class="btn btn-primary btn-square btn-ghost"
      hx-on:click="new_year_modal.showModal()"
      title="Add Year"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-6 h-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 4.5v15m7.5-7.5h-15"
        />
      </svg>
    </button>
    <dialog id="new_year_modal" class="modal">
      <div class="modal-box">{{ new_year_form|safe }}</div>
      <div hx-on:click="new_year_modal.close()" class="modal-backdrop"></div>
    </dialog>
  </div>
</div>
<div role="tabpanel">
  <div class="navbar bg-base-100">
    <div class="flex-1">
      <h1>{{ year }} Net Assets</h1>
    </div>
    <div class="flex-none">
      <button
        class="btn btn-square btn-ghost grid grid-cols-1 grid-rows-1"
        hx-post="/balance_sheet/resources/refresh"
        title="Refreshed Linked Resources"
        hx-swap="none"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="w-6 h-6 col-[1] row-[1] justify-self-center self-center"
        >
          <path
            fill-rule="evenodd"
            d="M12 5.25c1.213 0 2.415.046 3.605.135a3.256 3.256 0 0 1 3.01 3.01c.044.583.077 1.17.1 1.759L17.03 8.47a.75.75 0 1 0-1.06 1.06l3 3a.75.75 0 0 0 1.06 0l3-3a.75.75 0 0 0-1.06-1.06l-1.752 1.751c-.023-.65-.06-1.296-.108-1.939a4.756 4.756 0 0 0-4.392-4.392 49.422 49.422 0 0 0-7.436 0A4.756 4.756 0 0 0 3.89 8.282c-.017.224-.033.447-.046.672a.75.75 0 1 0 1.497.092c.013-.217.028-.434.044-.651a3.256 3.256 0 0 1 3.01-3.01c1.19-.09 2.392-.135 3.605-.135Zm-6.97 6.22a.75.75 0 0 0-1.06 0l-3 3a.75.75 0 1 0 1.06 1.06l1.752-1.751c.023.65.06 1.296.108 1.939a4.756 4.756 0 0 0 4.392 4.392 49.413 49.413 0 0 0 7.436 0 4.756 4.756 0 0 0 4.392-4.392c.017-.223.032-.447.046-.672a.75.75 0 0 0-1.497-.092c-.013.217-.028.434-.044.651a3.256 3.256 0 0 1-3.01 3.01 47.953 47.953 0 0 1-7.21 0 3.256 3.256 0 0 1-3.01-3.01 47.759 47.759 0 0 1-.1-1.759L6.97 15.53a.75.75 0 0 0 1.06-1.06l-3-3Z"
            clip-rule="evenodd"
          />
        </svg>
        <div class="htmx-indicator btn-square bg-base-100 col-[1] row-[1] grid">
          <span
            class="loading loading-spinner loading-md justify-self-center self-center"
          ></span>
        </div>
      </button>
      <a
        class="btn btn-primary btn-square btn-ghost"
        hx-target="#main"
        hx-select="#main > *"
        href="/balance_sheet/years/{{ year }}/new"
        title="Add Financial Resource"
        ><svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="w-6 h-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 4.5v15m7.5-7.5h-15"
          />
        </svg>
      </a>
    </div>
  </div>
  {# TODO: this overflow breaks table-pin-rows... #}
  <div class="overflow-x-auto">
    <table
      id="assets-table"
      class="table table-pin-rows"
      hx-get="/balance_sheet/years/{{ year }}/total_assets"
      hx-trigger="balance-updated from:body"
      hx-target="#assets-table tbody > tr:last-of-type"
      hx-swap="outerHTML"
    >
      <thead>
        <tr class="border-t-success border-t-2">
          <th class="min-w-lg-content">Assets</th>
          {% for month in months %}
          <th class="text-right min-w-md-content">{{ month.month.name() }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for res in fin_res %} {% if res.base.resource_type.is_asset() %}
        <tr>
          <td class="min-w-lg-content">
            <div class="flex flex-row">
              <span class="self-center mr-2">{{ res.base.name }}</span>
              <div class="dropdown">
                <div
                  tabindex="0"
                  role="button"
                  class="btn btn-sm btn-square btn-ghost"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-6 h-6"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"
                    />
                  </svg>
                </div>
                <ul
                  class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box"
                >
                  <li>
                    <a
                      hx-target="#main"
                      hx-select="#main > *"
                      href="/balance_sheet/years/{{ year }}/{{ res.base.id }}/edit"
                      >Edit</a
                    >
                  </li>
                  <li>
                    <a
                      hx-target="#main"
                      hx-select="#main > *"
                      href="/balance_sheet/years/{{ year }}/{{ res.base.id }}"
                      >View</a
                    >
                  </li>
                  <li>
                    <a
                      href="#"
                      hx-delete="/balance_sheet/years/{{ year }}/{{ res.base.id }}"
                      hx-confirm="Are you sure you want to delete {{ res.base.name }}?"
                      hx-swap="outerHTML swap:1s"
                      hx-target="closest tr"
                      >Delete</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </td>
          {% for y_m_and_b in res.iter_all_balances() %}
          <td class="text-right min-w-md-content">
            {% let month = y_m_and_b.1 %} {% let balance = y_m_and_b.2 %} {% let
            fin_res_id = res.base.id %} {% include
            "partials/year-details/single-balance.html" %}
          </td>
          {% endfor %}
        </tr>
        {% endif %} {% endfor %} {% include
        "partials/year-details/total-assets.html" %}
      </tbody>
    </table>
    <table
      id="liabilities-table"
      class="table"
      hx-get="/balance_sheet/years/{{ year }}/total_liabilities"
      hx-trigger="balance-updated from:body"
      hx-target="#liabilities-table tbody > tr:last-of-type"
      hx-swap="outerHTML"
    >
      <thead>
        <tr class="border-t-error border-t-2">
          <th>Liabilities</th>
        </tr>
      </thead>
      <tbody>
        {% for res in fin_res %} {% if res.base.resource_type.is_liability() %}
        <tr>
          <td class="min-w-lg-content">
            <div class="flex flex-row">
              <span class="self-center mr-2">{{ res.base.name }}</span>
              <div class="dropdown">
                <div tabindex="0" role="button" class="btn btn-sm btn-ghost">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-6 h-6"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z"
                    />
                  </svg>
                </div>
                <ul
                  class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box"
                >
                  <li>
                    <a
                      hx-target="#main"
                      hx-select="#main > *"
                      href="/balance_sheet/years/{{ year }}/{{ res.base.id }}/edit"
                      >Edit</a
                    >
                  </li>
                  <li>
                    <a
                      hx-target="#main"
                      hx-select="#main > *"
                      href="/balance_sheet/years/{{ year }}/{{ res.base.id }}"
                      >View</a
                    >
                  </li>
                  <li>
                    <a
                      href="#"
                      hx-delete="/balance_sheet/years/{{ year }}/{{ res.base.id }}"
                      hx-confirm="Are you sure you want to delete this Financial Resource?"
                      hx-swap="outerHTML swap:1s"
                      hx-target="closest tr"
                      >Delete</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </td>
          {% for y_m_and_b in res.iter_all_balances() %}
          <td class="text-right min-w-md-content">
            {% let month = y_m_and_b.1 %} {% let balance = y_m_and_b.2 %} {% let
            fin_res_id = res.base.id %} {% include
            "partials/year-details/single-balance.html" %}
          </td>
          {% endfor %}
        </tr>
        {% endif %} {% endfor %} {% include
        "partials/year-details/total-liabilities.html" %}
      </tbody>
    </table>
    <table
      id="total-monthly-table"
      class="table"
      hx-get="/balance_sheet/years/{{ year }}/total_monthly"
      hx-trigger="balance-updated from:body"
      hx-target="this"
    >
      {% include "partials/year-details/total-monthly.html" %}
    </table>
  </div>
</div>
{% endblock %}
